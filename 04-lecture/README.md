# 04 - Gitlab, установка и настройка

## Requirements

- Git
- Docker
- cfssl (или самостоятельно создаём сертификаты предпочитаемым инструментом)

Аналогично 2-й лекции выполняем:

```bash
export SLURM_HOME=$HOME/Slurm.io # домашняя директория курса по-умолчанию
cd $SLURM_HOME/cicd/04-lecture
. init.sh
```

### Установка гитлаба локально

Если у вас Linux-среда и установлены все зависимости, вы можете запустить Gitlab локально с самоподписанными сертификатами. Сначала скопируйте необходимые скрипты в рабочее окружение (при необходимости, сначала выполните настройку своего окружения, как описано [в основном README](../README.md)).

```bash
cp -r 01-install-gitlab $SLURM_L04_WORKSPACE/
cd $SLURM_L04_WORKSPACE/01-install-gitlab
export GITLAB_HOME=$(pwd)
```

В репозитории представлены следующие скрипты:

```
01-install-gitlab/
├── 01-gen_ca.sh             # Создать корневой сертификат
├── 02-gen_gitlab_cert.sh    # Подписать им сертификат на gitlab.example.com
├── 03-create_hosts_entry.sh # Создать запись в hosts-файле gitlab.example.com -> 127.0.0.1
├── 04-distribute_certs.sh   # Разложить созданные сертификаты по необходимым путям, добавить
...                            # корневой сертификат в системное хранилище.
```

В последнем скрипте используется `update-ca-certificates`, если у вас centos-based система, данный бинарь может отсутствовать.

Выполните последовательно эти скрипты, а затем запустите `run.sh`. Будет скачан и запущен докер-образ `gitlab/gitlab-ce:14.8.6-ce.0`. За ходом запуска можно последить в логах `docker logs -f gitlab`.

В зависимости от производительности вашего устройства, первый запуск гитлаба может длится от одной до десятка минут. Определить, что гитлаб запустился можно будет, когда логи начнут писаться в JSON-формате и периодически будут появляться подобные заголовки в логах:

```
==> /var/log/gitlab/gitlab-rails/application_json.log <==
```

Теперь можно зайти на https://gitlab.example.com

Обычно, на linux-системах у браузеров собственные хранилища доверенных сертификатов. Вы можете либо добавить свежесозданный корневой сертификат (скрипт по-умолчанию его кладёт по пути `/usr/local/share/ca-certificates/slurm.example.crt`) или игнорировать ошибки TLS.

При первом доступе гитлаб предложит назначить пароль для рут-пользователя (`login=='root'`).

Поздравляем, теперь у вас есть локальный гитлаб! Одна из самых незаменимых вещей для тестирования чего-либо -- возможность по-необходимости запускать подобные стенды.

В конфигурационном файле `01-install-gitlab/gitlab.rb` содержаться валидные настройки для LDAP-аутентификации и хранения артифактов в S3-совместимом хранилище, но по понятным причинам они закомментированы. Если у вас есть доступ к данным сервисам, например в вашей организации используется Active Directory или у вас есть своё S3-хранилище или вы пользуетесь объектным хранилищем от амазона, вы без труда адаптируете конфигурацию под свои нужды.

### Установка гитлаба на стенде

Переходим на стенд:

```
$ ssh sbox.slurm.io 
Last login: Wed Dec  2 12:23:09 2020 from 91.77.124.219
[s000297@sbox.slurm.io ~]$ ssh gitlab.s000297
Warning: Permanently added 'gitlab.s000297,172.17.42.21' (ECDSA) to the list of known hosts.
Last login: Wed Dec  2 09:23:13 2020 from 172.20.100.50
[s000297@gitlab.s000297.slurm.io ~]$ 
```

Точно так же настраиваем рабочее окружение, как и на локальной машине (см. [README](../README.md)) и выполняем скрипты инициализации к данной лекции:

```bash
export SLURM_HOME=$HOME/Slurm.io
cd $SLURM_HOME/cicd/04-lecture
. init.sh
```

```bash
cp -r 02-gitlab-sbox $SLURM_L04_WORKSPACE/
cd $SLURM_L04_WORKSPACE/02-gitlab-sbox
export GITLAB_HOME=$(pwd)
```

В отличии от локальной установки, здесь не требуется создавать самоподписные сертификаты. Обратите внимание на файл `02-gitlab-sbox/gitlab.rb.template`. В нём содержаться строки

```ruby
external_url 'https://gitlab.__SLURM_USERNAME__.edu.slurm.io'
nginx['redirect_http_to_https'] = true
letsencrypt['enable'] = true
```

Скрипт запуска контейнера подставит ваше имя пользователя вместо `__SLURM_USERNAME__`, а поскольку учебный стенд имеет публичное DNS имя, то мы можем воспользоваться [LetsEncrypt](https://letsencrypt.org/), чтобы получить действительный сертификат на наш инстанс гитлаба.

Запустите `run.sh`. Длительность запуска гитлаба на учебном стенде порядка 10 минут. Запустите `check_gitlab.sh`. Запустится проверка успешного запуска гитлаба. Как только пойдет статус - OK, можете прервать работу скрипта и продолжить. Когда гитлаб успешно запустится, он будет доступен по адресу `https://gitlab.<ваше_имя_пользователя>.edu.slurm.io`. Не забудьте сразу же назначить пароль на администраторскую учётку, так как этот инстанс гитлаба доступен всем из интернета.
